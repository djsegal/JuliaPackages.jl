dpfehm differentiable subsurface physics simulator description dpfehm julia module includes differentiable numerical models focus earth subsurface especially fluid flow currently supports groundwater flow equations single phase flow richards equation airwater advectiondispersion equation d wave equation differentiable easily combined machine learning models workflow workflow train machine learning model mitigate injecting fluid earth subsurface induced seismicity leakage carbon dioxide details workflow available installation julia install dpfehm test running import pkg pkg add dpfehm pkg test dpfehm basic usage examples started dpfehm examples described detail illustrate basic usage patterns via examples steady singlephase flow transient richards equation steady singlephase flow solve steady single phase flow start importing libraries import dpfehm import gaussianrandomfields import optim import pyplot import random import zygote random seed set seed reproduce results run set grid regular grid nodes covers domain meters meters meters mins maxs size domain meters ns nodes grid coords neighbors areasoverlengths dpfehm regulargridd mins maxs ns build grid result gridbuilding variables coords matrix describing coordinates cell centers grid neighbors array describing cells neighbor cells third areasoverlengths array length equal length neighbors describes interface neighboring cells dividing length cell centers variable dumped volumes cells volumes cells steady example set boundary conditions qs zeros size coords injectionnode inject lower left corner qsinjectionnode e dirichletnodes int size coords fix pressure upper corner dirichleths zeros size coords dirichleths size coords variable qs describes fluid sourcessinks amount fluid injected cell grid qs example inject fluid node variable dirichletnodes list cells pressure fixed example pressure fixed cell cell sizecoords variable dirichleths describes pressures heads hydrology jargon cells fixed note length dirichleths sizecoords values ignored except indices appear dirichletnodes final set step moving solving equations construct heterogeneous conductivity field package gaussianrandomfields construct conductivity field correlation length meters mean logconductivity e meters note natural logarithm defining standard deviation logconductivity gaussianrandomfields construct field dimensions copied layers heterogeneity exists coordinate directions direction lambda meters correlation length logconductivity sigma standard deviation logconductivity mu mean log conductivity e clean sand cov gaussianrandomfields covariancefunction gaussianrandomfields matern lambda sigma xpts range mins maxs length ns ypts range mins maxs length ns numeigenvectors grf gaussianrandomfields gaussianrandomfield cov gaussianrandomfields karhunenloeve numeigenvectors xpts ypts logks zeros reverse ns logksd mu gaussianrandomfields sample grf generate random realization logconductivity field ns copy d field d layers view logks logksd conductivity field shown look solve flow define helper function logksksneighbors function flow solver conductivity interface cells previous construction defined conductivities cells converts logconductivity conductivity geometric mean move cells interfaces heart code call dpfehmgroundwatersteadystate solves single phase steady flow pose solveforh function calls function returns result reshaping logksksneighbors ks exp ks map neighbors ks map neighbors convert permeabilities nodes permeabilities connecting nodes function solveforh logks dirichleths assert length logks length qs ksneighbors logksksneighbors logks return reshape dpfehm groundwatersteadystate ksneighbors neighbors areasoverlengths dirichletnodes dirichleths qs reverse ns function hand solve using solveforh wrapper function previously defined function requires explicitly pass logks hydraulic conductivity dirichleths fixedhead boundary condition inputs dpfehmgroundwatersteadystate fixed global values solveforh logks dirichleths solve head head bottom layer domain shown note pressure lower corner fluid injection rest domain dpfehm allows compute gradient functions involving dpfehmgroundwatersteadystate using zygotegradient zygotepullback isfreenode nodeifreenodei freenodeinodei dpfehm getfreenodes length dirichleths dirichletnodes gradientnode nodeifreenodei div size coords gradientnodex coords gradientnode gradientnodey coords gradientnode grad zygote gradient solveforh gradientnode logks dirichleths calculate gradient involves redundant calculation forward pass functionevaluation zygote pullback solveforh gradientnode logks dirichleths pullback redo forward pass print gradient time grad compute gradient function involving solveforh using zygotepullback note function dpfehmgetfreenodes allows map indices free nodes ones fixedpressure boundary conditions nodes gradient logk bottom layer domain shown transient richards flow consider example using dpfehm solver richards equation model flow porous medium air water fill pores unsaturated flow example similar previous example start importing libraries setting grid lower resolution time boundary conditions conductivity import differentiablebackwardeuler import dpfehm import gaussianrandomfields import pyplot import random import zygote random seed set seed permeability set grid mins maxs size domain meters ns nodes grid coords neighbors areasoverlengths volumes dpfehm regulargridd mins maxs ns build grid set boundary conditions qs zeros size coords injectionnode inject lower left corner qsinjectionnode e dirichletnodes int size coords fix pressure upper corner dirichleths zeros size coords dirichleths size coords set conductivity field lambda meters correlation length logconductivity sigma standard deviation logconductivity mu mean log conductivity e clean sand cov gaussianrandomfields covariancefunction gaussianrandomfields matern lambda sigma xpts range mins maxs length ns ypts range mins maxs length ns numeigenvectors grf gaussianrandomfields gaussianrandomfield cov gaussianrandomfields karhunenloeve numeigenvectors xpts ypts logks zeros reverse ns logksd mu gaussianrandomfields sample grf generate random realization logconductivity field ns copy d field d layers view logks logksd solving timedependent time set initial condition define storage parameter note unsaturated flows storage parameter neglected achieved setting specificstorage array ones involves saturated flow include multiphase flow define couple parameters control hydraulic conductivity dependence saturation conductivity conductivity saturated multiplied relative permeability depends saturation varies set initial condition storage van genuchten parameters relative permeability h zeros size coords initial condition specificstorage fill size coords storage alphas fill length neighbors van genuchten relative permeability parameters ns fill length neighbors basic description complete start write code solving equations note solveforh function call dpfehmrichardssteadystate solve equations instead calls differentiablebackwardeulersteps argument differentiablebackwardeulersteps initial condition nodes controlled dirichlet boundary conditions call frichards frichardsu frichardsp describe paragraph argument initial time simulation time keyword arguments eventually passed differentialequationssolve step adds boundary conditions solution differentiablebackwardeulersteps solves equations free nodes nodes pressure fixed boundary conditions logksksneighbors ks exp ks map neighbors ks map neighbors convert permeabilities nodes permeabilities interface nodes using geometric mean isfreenode nodeifreenodei freenodeinodei dpfehm getfreenodes length qs dirichletnodes function solveforh logks dirichleths assert length logks length qs ksneighbors logksksneighbors logks ksneighbors dirichleths hrichards differentiablebackwardeuler steps hisfreenode frichards frichardsu frichardsp frichardst abstol e reltol e hwithbcs hcat map dpfehm addboundaryconditions hrichards dirichletnodes dirichleths isfreenode nodeifreenodei size hrichards add dirichlet boundary conditions return hwithbcs define key functions frichards frichardsu frichardsp previous paragraph function frichards basically tells differentiablebackwardeuler solve dudt frichards function richardsresiduals function frichardsu jacobian frichards respect variable integrated differentiablebackwardeuler compute jacobian richardsresiduals respect inputs using function dpfehmrichardsxyz xzy name argument defined dpfehm jargon dpfehm richards equation solve variable solving named psi frichardsu unpacks parameters calls dpfehmrichardspsi function frichardsp jacobian frichards respect parameter consists ks dirichleths dirichletpsis jargon dpfehm richards solver concatenate jacobians dpfehmrichardsks dpfehmrichardsdirichletpsis function frichardst currently unused principle jacobian frichards respect set functions differentiablebackwardeuler function frichards tells differentiablebackwardeuler solve dudtfrichards ks dirichleths unpack return dpfehm richardsresiduals ks neighbors areasoverlengths dirichletnodes dirichleths coords alphas ns qs specificstorage volumes function frichardsu differentiablebackwardeuler derivative frichards respect backward euler method ks dirichleths unpack return dpfehm richardspsi ks neighbors areasoverlengths dirichletnodes dirichleths coords alphas ns qs specificstorage volumes function frichardsp differentiablebackwardeuler derivative frichards respect computing gradients respect functions involving richards equation solution ks dirichleths unpack j dpfehm richardsks ks neighbors areasoverlengths dirichletnodes dirichleths coords alphas ns qs specificstorage volumes j dpfehm richardsdirichletpsis ks neighbors areasoverlengths dirichletnodes dirichleths coords alphas ns qs specificstorage volumes return hcat j j frichardst zeros length differentiablebackwardeuler api requires currently functions helper function unpack unpacks parameters array arrays unpack converts conductivities ks boundary conditions dirichleths packing parameters ks dirichleths packingunpacking differentiablebackwardeuler parameters single array function unpack assert length length neighbors size coords ks length neighbors dirichleths length neighbors length neighbors size coords return ks dirichleths solve equations using solveforh solveforh logks dirichleths solve head finally compute gradient functions involving solution equations using zygotegradient zygotepullback hflathd reshape reverse ns gradientnode div size coords ns ns gradientnodex coords gradientnode gradientnodey coords gradientnode grad zygote gradient hflathd solveforh gradientnode logks dirichleths calculate gradient involves redundant calculation forward pass advanced usage examples illustrate advanced usage including inverse combining dpfehm neural network flow discrete fracture networks solving advectiondispersion wave equations note numerical methods dpfehm flux approximation discretize equations means example fluid flux cell cell proportional pressure gradient pressure gradient approximated proportional pipj pi pj pressures cells respectively license dpfehm provided bsd style license file text package orchard suite internally c orchard development questions contribute dpfehm please repo pull request questions please contact daniel malley omalledlanlgov