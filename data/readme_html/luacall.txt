<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto"><a id="user-content-luacalljl" class="anchor" aria-hidden="true" href="#luacalljl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>LuaCall.jl</h1>
<p dir="auto">A Julia package for interoperability with <a href="https://www.lua.org/" rel="nofollow">Lua</a>.</p>
<p dir="auto">Functionality:</p>
<ul dir="auto">
<li>Calling any Julia function from Lua</li>
<li>Sharing any Julia object with Lua</li>
<li>Accessing any Lua data from Julia</li>
<li>Resuming Lua coroutines from Julia</li>
</ul>
<h2 dir="auto"><a id="user-content-showcase" class="anchor" aria-hidden="true" href="#showcase"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Showcase</h2>
<h3 dir="auto"><a id="user-content-call-julia-from-lua" class="anchor" aria-hidden="true" href="#call-julia-from-lua"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Call Julia from Lua</h3>
<p dir="auto">When LuaCall initializes a Lua state, a global variables <code>julia</code> represents the Julia module <code>Main</code>,
where you can access any Julia functions. Any Julia value involved is shared with Lua as opaque userdata.</p>
<p dir="auto">For example, you can do linear algebra from Lua</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="using LuaCall
LS = LuaState()
# Guard whatever Lua scope with @luascope
@luascope LS begin
    lua_inv = lualoadstring(LS, &quot;&quot;&quot;
        a = ...
        return julia.inv(a)
        &quot;&quot;&quot;)
    inv = lua_inv([1 2; 3 4])
    get_julia(inv)  # =&gt; [-2 -1; 1.5 -0.5]
end"><pre><span class="pl-k">using</span> LuaCall
LS <span class="pl-k">=</span> <span class="pl-c1">LuaState</span>()
<span class="pl-c"><span class="pl-c">#</span> Guard whatever Lua scope with @luascope</span>
<span class="pl-c1">@luascope</span> LS <span class="pl-k">begin</span>
    lua_inv <span class="pl-k">=</span> <span class="pl-c1">lualoadstring</span>(LS, <span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">        a = ...</span>
<span class="pl-s">        return julia.inv(a)</span>
<span class="pl-s">        <span class="pl-pds">"""</span></span>)
    inv <span class="pl-k">=</span> <span class="pl-c1">lua_inv</span>([<span class="pl-c1">1</span> <span class="pl-c1">2</span>; <span class="pl-c1">3</span> <span class="pl-c1">4</span>])
    <span class="pl-c1">get_julia</span>(inv)  <span class="pl-c"><span class="pl-c">#</span> =&gt; [-2 -1; 1.5 -0.5]</span>
<span class="pl-k">end</span></pre></div>
<h3 dir="auto"><a id="user-content-calling-lua-from-julia" class="anchor" aria-hidden="true" href="#calling-lua-from-julia"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Calling Lua from Julia</h3>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="using LuaCall
LS = LuaState()
@luascope LS begin
    code = lualoadstring(LS, &quot;&quot;&quot;
        return {a=1, [2]=&quot;hello&quot;}, coroutine.create(function (a)
            b = coroutine.yield(a + 1)
            return a + b
        end)&quot;&quot;&quot;)
    table, thread = code(; multiret=true)
    a = table[&quot;a&quot;]
    b = table[2]
    c = resume(LS, thread, 3)
    d = resume(LS, thread, 4)
    a, b, c, d # =&gt; (1, &quot;hello&quot;, 4, 7)
end"><pre><span class="pl-k">using</span> LuaCall
LS <span class="pl-k">=</span> <span class="pl-c1">LuaState</span>()
<span class="pl-c1">@luascope</span> LS <span class="pl-k">begin</span>
    code <span class="pl-k">=</span> <span class="pl-c1">lualoadstring</span>(LS, <span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">        return {a=1, [2]="hello"}, coroutine.create(function (a)</span>
<span class="pl-s">            b = coroutine.yield(a + 1)</span>
<span class="pl-s">            return a + b</span>
<span class="pl-s">        end)<span class="pl-pds">"""</span></span>)
    table, thread <span class="pl-k">=</span> <span class="pl-c1">code</span>(; multiret<span class="pl-k">=</span><span class="pl-c1">true</span>)
    a <span class="pl-k">=</span> table[<span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>]
    b <span class="pl-k">=</span> table[<span class="pl-c1">2</span>]
    c <span class="pl-k">=</span> <span class="pl-c1">resume</span>(LS, thread, <span class="pl-c1">3</span>)
    d <span class="pl-k">=</span> <span class="pl-c1">resume</span>(LS, thread, <span class="pl-c1">4</span>)
    a, b, c, d <span class="pl-c"><span class="pl-c">#</span> =&gt; (1, "hello", 4, 7)</span>
<span class="pl-k">end</span></pre></div>
<h2 dir="auto"><a id="user-content-lua-api-overview" class="anchor" aria-hidden="true" href="#lua-api-overview"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Lua API overview</h2>
<p dir="auto">Each Lua session is contained in a Lua state, <code>lua_State</code> in C or <code>LuaState</code> in Julia. While Lua sessions do not
share data among each other, any access to a Lua state may affect its internal state. Of most concern is the
<strong>stack</strong> of one state, where the Lua state stores its execution context. To hide implimentation details for Lua
users, we can not use pointers to access Lua objects. Instead, we must reference it as one specific index into the
stack, which has substantial impact on the design of this package:</p>
<ul dir="auto">
<li>The Lua API itself uses the stack to transfer data, may reference the data on the stack, or pop/push any object.</li>
<li>LuaCall duplicates the poped elements so that no objects will be removed.</li>
<li>However, new objects must be located on the stack, potentially leaking memory.</li>
<li><code>@luascope</code> resets the top of the stack to remove all elements pushed in the block.</li>
<li><code>@luareturn</code> can be used to return elements on the Lua stack, that is, remove any other elements but leave the returned
object.</li>
<li>Any object on the Lua stack is wrapped in <code>PopStack</code>, which is automatically unwrapped if appear on the right-hand-side
of assignment in a <code>@luascope</code> block. You can manually unwrap it with <code>[]</code>, e.g. <code>table[key][]</code> returns the value unwrapped.</li>
<li>You can also manage stack manually with <code>push!</code> and <code>pop!</code>.</li>
</ul>
<p dir="auto">Example:</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="@luascope LUA_STATE begin
  array = [1,2,3]
  array2 = @luascope LUA_STATE begin
      table = new_table!(LUA_STATE)
      # stack: [table1]
      table[1] = array
      # stack: [table] (unmodified)
      userdata = table[1]
      # stack: [table userdata(array)]
      @luareturn userdata
  end
  # stack: [userdata(array)]
  get_julia(array2[]) == array
end
# stack: []"><pre><span class="pl-c1">@luascope</span> LUA_STATE <span class="pl-k">begin</span>
  array <span class="pl-k">=</span> [<span class="pl-c1">1</span>,<span class="pl-c1">2</span>,<span class="pl-c1">3</span>]
  array2 <span class="pl-k">=</span> <span class="pl-c1">@luascope</span> LUA_STATE <span class="pl-k">begin</span>
      table <span class="pl-k">=</span> <span class="pl-c1">new_table!</span>(LUA_STATE)
      <span class="pl-c"><span class="pl-c">#</span> stack: [table1]</span>
      table[<span class="pl-c1">1</span>] <span class="pl-k">=</span> array
      <span class="pl-c"><span class="pl-c">#</span> stack: [table] (unmodified)</span>
      userdata <span class="pl-k">=</span> table[<span class="pl-c1">1</span>]
      <span class="pl-c"><span class="pl-c">#</span> stack: [table userdata(array)]</span>
      <span class="pl-c1">@luareturn</span> userdata
  <span class="pl-k">end</span>
  <span class="pl-c"><span class="pl-c">#</span> stack: [userdata(array)]</span>
  <span class="pl-c1">get_julia</span>(array2[]) <span class="pl-k">==</span> array
<span class="pl-k">end</span>
<span class="pl-c"><span class="pl-c">#</span> stack: []</span></pre></div>
<h2 dir="auto"><a id="user-content-type-mapping" class="anchor" aria-hidden="true" href="#type-mapping"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Type mapping</h2>
<table>
<thead>
<tr>
<th>Lua type</th>
<th>To Julia type</th>
<th>From Julia type</th>
<th>On Lua stack</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>nil</code></td>
<td><code>nothing</code>(value)</td>
<td><code>nothing</code></td>
<td><g-emoji class="g-emoji" alias="x" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png">❌</g-emoji></td>
</tr>
<tr>
<td>integer</td>
<td><code>LuaInt</code>(<code>Int64</code>)</td>
<td><code>AbstractInt</code></td>
<td><g-emoji class="g-emoji" alias="x" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png">❌</g-emoji></td>
</tr>
<tr>
<td>floating point</td>
<td><code>LuaFloat</code>(<code>Float64</code>)</td>
<td><code>AbstractFloat</code></td>
<td><g-emoji class="g-emoji" alias="x" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png">❌</g-emoji></td>
</tr>
<tr>
<td>string</td>
<td><code>String</code></td>
<td><code>AbstractString</code></td>
<td><g-emoji class="g-emoji" alias="x" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png">❌</g-emoji></td>
</tr>
<tr>
<td>table</td>
<td><code>LuaTable</code></td>
<td>*</td>
<td><g-emoji class="g-emoji" alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔</g-emoji></td>
</tr>
<tr>
<td>function</td>
<td><code>LuaFunction</code></td>
<td>*</td>
<td><g-emoji class="g-emoji" alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔</g-emoji></td>
</tr>
<tr>
<td>userdata</td>
<td><code>LuaUserData</code>, <code>Any</code></td>
<td><code>Any</code></td>
<td><g-emoji class="g-emoji" alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔</g-emoji></td>
</tr>
<tr>
<td>thread</td>
<td><code>LuaThread</code></td>
<td>*</td>
<td><g-emoji class="g-emoji" alias="heavy_check_mark" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png">✔</g-emoji></td>
</tr>
</tbody>
</table>
<p dir="auto">You can retrive any value on the Lua stack with <code>LUA_STATE[index]</code> or <code>getstack(LUA_STATE, index)</code>.
To retrive the Julia value contained in a Lua userdata, use <code>get_julia</code>.</p>
<p dir="auto">To push value to the stack with default conversion, use <code>push!(LUA_STATE, values...)</code>.
To construct mutable object from Julia, check <code>new_table!</code>, <code>new_cfunction!</code>, <code>new_userdata</code> and <code>new_thread!</code>.</p>
</article></div>