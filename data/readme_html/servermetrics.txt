<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto"><a id="user-content-servermetricsjl" class="anchor" aria-hidden="true" href="#servermetricsjl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>ServerMetrics.jl</h1>
<p dir="auto">Server metrics allow engineers to instrument their code to expose useful information about
what is happening within the server (a program running on a single machine).</p>
<p dir="auto">Metrics are primarily numeric representations of either current state (e.g. how much disk
are we using at the moment) or event counters (how many requests did we handle so far).</p>
<p dir="auto">Currently, two flavors of metrics are supported:</p>
<ol dir="auto">
<li><code>Gauge</code>s represent current state of some measure, such as "bytes stored on disk". The
value can fluctuate and change over time.</li>
<li><code>Counter</code>s count events of interest or aggregations of values over time. The guarantee
is that the value of a counter never decreases and what usually matters is not the value
itself but rather how it changes over time.</li>
</ol>
<p dir="auto">And two backends are supported: DataDog and Prometheus. See the <code>examples</code> directory for
how to set up in either configuration.</p>
<h2 dir="auto"><a id="user-content-basic-operation" class="anchor" aria-hidden="true" href="#basic-operation"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Basic operation</h2>
<p dir="auto">The library allows user to construct <code>Counter</code>s and <code>Gauge</code>s either individually
or (preferably) wrapped in <code>MetricCollection</code> structures. Metrics or collections can be
registered with either <em>default registry</em> or with custom registries. Upon registration,
metrics need to have unique names assigned to them.</p>
<p dir="auto">Metric registries can be set up to publish the state of the registered metrics to a variety
of backends, specifically the library offers:</p>
<ol dir="auto">
<li>StatsdExporter that will periodically send UDP messages to the statsd backend</li>
<li>Prometheus compatible http request handler that can serve the state of registered
metric on <code>/metrics</code> (or custom) http endpoint.</li>
</ol>
<h2 dir="auto"><a id="user-content-metric-labels" class="anchor" aria-hidden="true" href="#metric-labels"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Metric labels</h2>
<p dir="auto">Metrics can either be scalars (a single number) or they can have one or more labels. This
can be thought of as having sparse matrices where many related measures are tracked.</p>
<p dir="auto">An example of this is http response tracking where we may want to break this down by
action (GET/PUT) and http response code. To do this, simply create <code>Gauge</code> or <code>Counter</code>
and list all the labels and the value type:</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="responses_total = Counter(; action=String, response_code=Int64)"><pre>responses_total <span class="pl-k">=</span> <span class="pl-c1">Counter</span>(; action<span class="pl-k">=</span>String, response_code<span class="pl-k">=</span>Int64)</pre></div>
<p dir="auto">To manipulate these metrics, you will need to pass label assignments:</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="inc!(responses_total; action=&quot;GET&quot;, response_code=500)
inc!(responses_total; action=&quot;PUT&quot;, response_code=200)"><pre><span class="pl-c1">inc!</span>(responses_total; action<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, response_code<span class="pl-k">=</span><span class="pl-c1">500</span>)
<span class="pl-c1">inc!</span>(responses_total; action<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>PUT<span class="pl-pds">"</span></span>, response_code<span class="pl-k">=</span><span class="pl-c1">200</span>)</pre></div>
<p dir="auto">Keep in mind the following rules:</p>
<ul dir="auto">
<li>If invalid labels are set when manipulating metrics (e.g. some labels are missing,
unkown labels are set or label value is of a wrong type), the library will log
an error and drop the operation on the floor. This is to ensure that bugs in the
instrumentation won't crash the service in production.</li>
<li>Each metric is limited to 200 distinct values (distinguished by unique label-value
assignments). When this limit is reached, least recently used cell is deleted.
This limit is in place to ensure that poorly written instrumentation code will not
be able to leak memory, incur excessive datadog costs (we pay for each cell)
or cause performance issues in the instrumentation code.</li>
</ul>
<h2 dir="auto"><a id="user-content-instrumenting-your-code" class="anchor" aria-hidden="true" href="#instrumenting-your-code"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Instrumenting your code</h2>
<p dir="auto">To instrument your module with server metrics you will first need to create a subclass of
<code>ServerMetrics.AbstractMetricCollection</code> that will hold your metrics.</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="using ServerMetrics

Base.@kwdef struct MyModuleMetrics &lt;: AbstractMetricCollection
    lunches_consumed = Counter()
    hunger_level = Gauge(5.0)  # Hunger starts at 5.0
end"><pre><span class="pl-k">using</span> ServerMetrics

Base<span class="pl-k">.</span><span class="pl-c1">@kwdef</span> <span class="pl-k">struct</span> MyModuleMetrics <span class="pl-k">&lt;:</span> <span class="pl-c1">AbstractMetricCollection</span>
    lunches_consumed <span class="pl-k">=</span> <span class="pl-c1">Counter</span>()
    hunger_level <span class="pl-k">=</span> <span class="pl-c1">Gauge</span>(<span class="pl-c1">5.0</span>)  <span class="pl-c"><span class="pl-c">#</span> Hunger starts at 5.0</span>
<span class="pl-k">end</span></pre></div>
<p dir="auto">If you want these metrics to be exposed to production monitoring systems by default, you will
want to create a global const instance of this structure and add it to the default metric registry at the module <code>__init__()</code> using the following:</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="const metrics = MyModuleMetrics()

function __init__()
  ServerMetrics.publish_metrics_from(metrics)
end"><pre><span class="pl-k">const</span> metrics <span class="pl-k">=</span> <span class="pl-c1">MyModuleMetrics</span>()

<span class="pl-k">function</span> <span class="pl-en">__init__</span>()
  ServerMetrics<span class="pl-k">.</span><span class="pl-c1">publish_metrics_from</span>(metrics)
<span class="pl-k">end</span></pre></div>
<p dir="auto">And then you can instrument your code by manipulating metrics within the <code>metrics</code> instance:</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="function eat_lunch()
    inc!(metrics.lunches_consumed)
    dec!(metrics.hunger_level)
    # ... eat lunch here ...
end

function exercise_little()
    inc!(metrics.hunger_level)
    # ... do the exercises ...
end

function exercise_a_lot()
    inc!(metrics.hunger_level, 3.0)
    # ... do the exercises ...
end"><pre><span class="pl-k">function</span> <span class="pl-en">eat_lunch</span>()
    <span class="pl-c1">inc!</span>(metrics<span class="pl-k">.</span>lunches_consumed)
    <span class="pl-c1">dec!</span>(metrics<span class="pl-k">.</span>hunger_level)
    <span class="pl-c"><span class="pl-c">#</span> ... eat lunch here ...</span>
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">exercise_little</span>()
    <span class="pl-c1">inc!</span>(metrics<span class="pl-k">.</span>hunger_level)
    <span class="pl-c"><span class="pl-c">#</span> ... do the exercises ...</span>
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">exercise_a_lot</span>()
    <span class="pl-c1">inc!</span>(metrics<span class="pl-k">.</span>hunger_level, <span class="pl-c1">3.0</span>)
    <span class="pl-c"><span class="pl-c">#</span> ... do the exercises ...</span>
<span class="pl-k">end</span></pre></div>
<h2 dir="auto"><a id="user-content-naming-conventions" class="anchor" aria-hidden="true" href="#naming-conventions"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Naming conventions</h2>
<p dir="auto">See <a href="https://prometheus.io/docs/practices/naming/" rel="nofollow">https://prometheus.io/docs/practices/naming/</a> as a starting point.</p>
<p dir="auto">Important points:</p>
<ul dir="auto">
<li>Units should be included as part of the metric name. For example, a gauge metric tracking
memory might be called <code>memory_usage_bytes</code>.</li>
<li>The first word should indicate what part of the system is exporting the metric. It may
make sense to make these multi-tiered (e.g., <code>pager_memory_usage_bytes</code>,
<code>julia_memory_usage_bytes</code>)</li>
<li>You should never change the type of an existing metric, for backward compatibility
reasons. (Imagine a rollout where multiple versions are running and exporting different
types to the same metric; not a good look). It's better to create a metric with a new
name to change types.</li>
</ul>
<h2 dir="auto"><a id="user-content-testing-locally" class="anchor" aria-hidden="true" href="#testing-locally"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Testing locally</h2>
<p dir="auto">You can use Prometheus and Grafana to test metrics locally.</p>
<p dir="auto">Depending on platform (assuming linux), follow the default installation instructions for both:</p>
<ul dir="auto">
<li><a href="https://prometheus.io/docs/introduction/first_steps/" rel="nofollow">https://prometheus.io/docs/introduction/first_steps/</a></li>
<li><a href="https://grafana.com/grafana/download" rel="nofollow">https://grafana.com/grafana/download</a></li>
</ul>
<p dir="auto">Then configure prometheus to scrape the local instance by adding the following section into prometheus.yml:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="  - job_name: 'your-local-job'
    scrape_interval: 1s
    static_configs:
      - targets: ['localhost:&lt;your-port&gt;']"><pre class="notranslate"><code>  - job_name: 'your-local-job'
    scrape_interval: 1s
    static_configs:
      - targets: ['localhost:&lt;your-port&gt;']
</code></pre></div>
<p dir="auto">Upon starting grafana, you can connect it to prometheus data source which should give you access to all exported metrics.</p>
</article></div>