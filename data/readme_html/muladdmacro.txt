<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1><a id="user-content-muladdmacrojl" class="anchor" aria-hidden="true" href="#muladdmacrojl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>MuladdMacro.jl</h1>
<p><a href="https://github.com/SciML/MuladdMacro.jl/actions?query=workflow%3ACI"><img src="https://github.com/SciML/MuladdMacro.jl/workflows/CI/badge.svg" alt="Build Status" style="max-width:100%;"></a>
<a href="https://coveralls.io/github/JuliaDiffEq/MuladdMacro.jl?branch=master" rel="nofollow"><img src="https://camo.githubusercontent.com/efcb67784356aeb16f73ff4b5002fae3624b013cb1143a90260dbc163de5df55/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f4a756c69614469666645712f4d756c6164644d6163726f2e6a6c2f62616467652e7376673f6272616e63683d6d6173746572" alt="Coverage Status" data-canonical-src="https://coveralls.io/repos/github/JuliaDiffEq/MuladdMacro.jl/badge.svg?branch=master" style="max-width:100%;"></a>
<a href="http://codecov.io/github/JuliaDiffEq/MuladdMacro.jl?branch=master" rel="nofollow"><img src="https://camo.githubusercontent.com/22c8f6e775cbeb10f44b7ed09a0871fba08567bc75732dedf167d3fdc673f9a3/687474703a2f2f636f6465636f762e696f2f6769746875622f4a756c69614469666645712f4d756c6164644d6163726f2e6a6c2f636f7665726167652e7376673f6272616e63683d6d6173746572" alt="codecov.io" data-canonical-src="http://codecov.io/github/JuliaDiffEq/MuladdMacro.jl/coverage.svg?branch=master" style="max-width:100%;"></a></p>
<p>This package provides the <code>@muladd</code> macro. It automatically converts expressions
with multiplications and additions or subtractions to calls with <code>muladd</code> which then fuse via
FMA when it would increase the performance of the code. The <code>@muladd</code> macro
can be placed on code blocks and it will automatically find the appropriate
expressions and nest muladd expressions when necessary. In mixed expressions summands without multiplication will be grouped together and evaluated first but otherwise the order of evaluation of multiplications and additions is not changed.</p>
<h2><a id="user-content-examples" class="anchor" aria-hidden="true" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Examples</h2>
<div class="highlight highlight-source-julia position-relative" data-snippet-clipboard-copy-content="julia&gt; @macroexpand(@muladd k3 = f(t + c3*dt, @. uprev+dt*(a031*k1+a032*k2)))
:(k3 = f((muladd)(c3, dt, t), (muladd).(dt, (muladd).(a032, k2, (*).(a031, k1)), uprev)))

julia&gt; @macroexpand(@muladd integrator.EEst = integrator.opts.internalnorm((update - dt*(bhat1*k1 + bhat4*k4 + bhat5*k5 + bhat6*k6 + bhat7*k7 + bhat10*k10))./ @. (integrator.opts.abstol+max(abs(uprev),abs(u))*integrator.opts.reltol)))
:(integrator.EEst = (integrator.opts).internalnorm((muladd)(-dt, (muladd)(bhat10, k10, (muladd)(bhat7, k7, (muladd)(bhat6, k6, (muladd)(bhat5, k5, (muladd)(bhat4, k4, bhat1 * k1))))), update) ./ (muladd).(max.(abs.(uprev), abs.(u)), (integrator.opts).reltol, (integrator.opts).abstol)))
"><pre>julia<span class="pl-k">&gt;</span> <span class="pl-c1">@macroexpand</span>(<span class="pl-c1">@muladd</span> k3 <span class="pl-k">=</span> <span class="pl-c1">f</span>(t <span class="pl-k">+</span> c3<span class="pl-k">*</span>dt, <span class="pl-c1">@.</span> uprev<span class="pl-k">+</span>dt<span class="pl-k">*</span>(a031<span class="pl-k">*</span>k1<span class="pl-k">+</span>a032<span class="pl-k">*</span>k2)))
:(k3 <span class="pl-k">=</span> <span class="pl-c1">f</span>((muladd)(c3, dt, t), (muladd).(dt, (muladd).(a032, k2, (<span class="pl-k">*</span>).(a031, k1)), uprev)))

julia<span class="pl-k">&gt;</span> <span class="pl-c1">@macroexpand</span>(<span class="pl-c1">@muladd</span> integrator<span class="pl-k">.</span>EEst <span class="pl-k">=</span> integrator<span class="pl-k">.</span>opts<span class="pl-k">.</span><span class="pl-c1">internalnorm</span>((update <span class="pl-k">-</span> dt<span class="pl-k">*</span>(bhat1<span class="pl-k">*</span>k1 <span class="pl-k">+</span> bhat4<span class="pl-k">*</span>k4 <span class="pl-k">+</span> bhat5<span class="pl-k">*</span>k5 <span class="pl-k">+</span> bhat6<span class="pl-k">*</span>k6 <span class="pl-k">+</span> bhat7<span class="pl-k">*</span>k7 <span class="pl-k">+</span> bhat10<span class="pl-k">*</span>k10))<span class="pl-k">./</span> <span class="pl-c1">@.</span> (integrator<span class="pl-k">.</span>opts<span class="pl-k">.</span>abstol<span class="pl-k">+</span><span class="pl-c1">max</span>(<span class="pl-c1">abs</span>(uprev),<span class="pl-c1">abs</span>(u))<span class="pl-k">*</span>integrator<span class="pl-k">.</span>opts<span class="pl-k">.</span>reltol)))
:(integrator<span class="pl-k">.</span>EEst <span class="pl-k">=</span> (integrator<span class="pl-k">.</span>opts)<span class="pl-k">.</span><span class="pl-c1">internalnorm</span>((muladd)(<span class="pl-k">-</span>dt, (muladd)(bhat10, k10, (muladd)(bhat7, k7, (muladd)(bhat6, k6, (muladd)(bhat5, k5, (muladd)(bhat4, k4, bhat1 <span class="pl-k">*</span> k1))))), update) <span class="pl-k">./</span> (muladd).(<span class="pl-c1">max</span>.(<span class="pl-c1">abs</span>.(uprev), <span class="pl-c1">abs</span>.(u)), (integrator<span class="pl-k">.</span>opts)<span class="pl-k">.</span>reltol, (integrator<span class="pl-k">.</span>opts)<span class="pl-k">.</span>abstol)))</pre></div>
<h2><a id="user-content-broadcasting" class="anchor" aria-hidden="true" href="#broadcasting"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Broadcasting</h2>
<p>A <code>muladd</code> call will be broadcasted if both the <code>*</code> and the <code>+</code> or <code>-</code> are broadcasted.
If either one is not broadcasted, then the expression will be converted to a
non-dotted <code>muladd</code>.</p>
<h2><a id="user-content-credit" class="anchor" aria-hidden="true" href="#credit"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Credit</h2>
<p>Most of the credit goes to @fcard and @devmotion for building the first version
and greatly refining the macro. These contributions are not directly shown as
this was developed in Gitter chats and in the DiffEqBase.jl repository, but
these two individuals did almost all of the work.</p>
</article></div>