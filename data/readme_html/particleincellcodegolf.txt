<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto"><a id="user-content-particleincellcodegolfjl" class="anchor" aria-hidden="true" href="#particleincellcodegolfjl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>ParticleInCellCodeGolf.jl</h1>
<p dir="auto">This is a silly repo for tiny inscrutable PIC codes!</p>
<p dir="auto">So far they are all a collisionless electrostatic 1D1V (one spatial dimension
and one velocity dimension) particle-in-cell codes.</p>
<p dir="auto"><strong>Warning: There will be bugs!</strong></p>
<h2 dir="auto"><a id="user-content-7-lines" class="anchor" aria-hidden="true" href="#7-lines"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>7 Lines</h2>
<p dir="auto">I wrote this one for fun for the Julia discourse thread <a href="https://discourse.julialang.org/t/seven-lines-of-julia-examples-sought/50416/113?u=jcook" rel="nofollow">Seven Lines of Julia (examples sought)</a>.</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="using FFTW,Plots;N=128;P=64N;dt=1/4N;NT=1024;W=200;w=W/P*N;
x=rand(P);v=collect(1:P.&gt;P/2).*2 .-1;u()=(x.=mod.(x.+v/2*dt,1));n=zeros(N);
k=im.*2π*vcat(1,1:N/2,-N/2+1:-1);f(x)=Int(mod1(round(x*N),N));Σ=sum;
@gif for t in 1:NT;
  u();E=real.(ifft((E=fft((n.*=0;for j∈x;n[f(j)]+=w;end;n))./k;E[1]*=0;E)));
  u();v+=E[f.(x)]*dt;scatter(x,v,ylims=(-3,3),legend=false);
end every 8"><pre><span class="pl-k">using</span> FFTW,Plots;N<span class="pl-k">=</span><span class="pl-c1">128</span>;P<span class="pl-k">=</span><span class="pl-c1">64</span>N;dt<span class="pl-k">=</span><span class="pl-c1">1</span><span class="pl-k">/</span><span class="pl-c1">4</span>N;NT<span class="pl-k">=</span><span class="pl-c1">1024</span>;W<span class="pl-k">=</span><span class="pl-c1">200</span>;w<span class="pl-k">=</span>W<span class="pl-k">/</span>P<span class="pl-k">*</span>N;
x<span class="pl-k">=</span><span class="pl-en">rand</span>(P);v<span class="pl-k">=</span><span class="pl-en">collect</span>(<span class="pl-c1">1</span><span class="pl-k">:</span>P<span class="pl-k">.&gt;</span>P<span class="pl-k">/</span><span class="pl-c1">2</span>)<span class="pl-k">.</span><span class="pl-k">*</span><span class="pl-c1">2</span> <span class="pl-k">.-</span><span class="pl-c1">1</span>;<span class="pl-en">u</span>()<span class="pl-k">=</span>(x<span class="pl-k">.=</span><span class="pl-c1">mod</span>.(x<span class="pl-k">.+</span>v<span class="pl-k">/</span><span class="pl-c1">2</span><span class="pl-k">*</span>dt,<span class="pl-c1">1</span>));n<span class="pl-k">=</span><span class="pl-c1">zeros</span>(N);
k<span class="pl-k">=</span>im<span class="pl-k">.*</span><span class="pl-c1">2</span>π<span class="pl-k">*</span><span class="pl-en">vcat</span>(<span class="pl-c1">1</span>,<span class="pl-c1">1</span><span class="pl-k">:</span>N<span class="pl-k">/</span><span class="pl-c1">2</span>,<span class="pl-k">-</span>N<span class="pl-k">/</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-k">-</span><span class="pl-c1">1</span>);<span class="pl-en">f</span>(x)<span class="pl-k">=</span><span class="pl-c1">Int</span>(<span class="pl-c1">mod1</span>(<span class="pl-c1">round</span>(x<span class="pl-k">*</span>N),N));Σ<span class="pl-k">=</span>sum;
<span class="pl-c1">@gif</span> <span class="pl-k">for</span> t <span class="pl-k">in</span> <span class="pl-c1">1</span><span class="pl-k">:</span>NT;
  <span class="pl-c1">u</span>();E<span class="pl-k">=</span><span class="pl-c1">real</span>.(<span class="pl-c1">ifft</span>((E<span class="pl-k">=</span><span class="pl-c1">fft</span>((n<span class="pl-k">.*=</span><span class="pl-c1">0</span>;<span class="pl-k">for</span> j<span class="pl-k">∈</span>x;n[<span class="pl-c1">f</span>(j)]<span class="pl-k">+=</span>w;<span class="pl-k">end</span>;n))<span class="pl-k">./</span>k;E[<span class="pl-c1">1</span>]<span class="pl-k">*=</span><span class="pl-c1">0</span>;E)));
  <span class="pl-c1">u</span>();v<span class="pl-k">+=</span>E[<span class="pl-c1">f</span>.(x)]<span class="pl-k">*</span>dt;<span class="pl-c1">scatter</span>(x,v,ylims<span class="pl-k">=</span>(<span class="pl-k">-</span><span class="pl-c1">3</span>,<span class="pl-c1">3</span>),legend<span class="pl-k">=</span><span class="pl-c1">false</span>);
<span class="pl-k">end</span> every <span class="pl-c1">8</span></pre></div>
<p dir="auto">It uses Nearest Grid Point (NGP) particle deposition to acculumate charge on a
grid and a fast Fourier transform (FFT) to calculate the electric field. It uses
an explicit leapfrog (Verlet) time stepper where the CFL condition hard coded
but is set by the fastest particle in the simulation.</p>
<p dir="auto">The code is set up to display the two-stream instability:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/jwscook/ParticleInCellCodeGolf.jl/blob/main/gifs/NGPFourierWithDiagnostics.gif"><img src="https://github.com/jwscook/ParticleInCellCodeGolf.jl/raw/main/gifs/NGPFourierWithDiagnostics.gif" alt="" data-animated-image="" style="max-width: 100%;"></a></p>
<p dir="auto">Points represent the particles and The traces drawn across the plot represent
the total energy, particle energy, wave energy, and total momentum, from top to
bottom respectively (gif generated with src/NGPFourierWithDiagnostics.jl).</p>
<h2 dir="auto"><a id="user-content-gaussian-shapes-particles" class="anchor" aria-hidden="true" href="#gaussian-shapes-particles"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Gaussian shapes particles</h2>
<p dir="auto">NGP particles are so noisey so I created a PIC code where the particles all have
Gaussian shapes. Charge is deposited in each cell based on the integral of the
shape function across each cell.</p>
<p dir="auto">Now that particles' charge smoothly transition between cells and being inspired
by implicit PIC methods, I thought I'd add
some fixed point iteration to calculate the mid-point electric field from
updates to the particles' positions and velocities. This conserves momentum
perfectly and does a pretty great job at keeping energy bounded too.
Furthermore, the CFL condition is lifted! (at the expense of energy conservation
being not quite so good.)</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="using FFTW,LinearAlgebra,Plots,SpecialFunctions;N=128;P=32N;dt=1/6N;T=1024;
W=400;w=W/P*N;ξ=im*zeros(N);x=rand(P);v=rand([-1.0,1.0],P);r=zeros(N);
E=zeros(N);X=copy(x);V=copy(v);ik=2π*im*vcat(1,1:N/2,-N/2+1:-1);D=zeros(T,4);
f(g,c)=erf((g-c)*N)/2;ff(i,c)=f((i+0.5)/N,c)-f((i-0.5)/N,c);l=1e-8;
d(c)=((mod1(i,N),ff(i,c)) for i∈(-6:6).+Int(round(c*N)));F=copy(E);
ρ(x,y)=(r.*=0;for j∈d.((x.+y)./2);for k∈j;r[k[1]]+=k[2]*w;end;end;r);
@gif for t ∈1:T;X.=x;V.=v;F.*=NaN;for _∈0:9;isapprox(F,E,rtol=l)&amp;&amp;break;F.=E;
  x.=X.+(v.+V)/2*dt;E.=real.(ifft((ξ.=fft(ρ(x,X))./ik;ξ[1]*=0;ξ)));
  for j∈1:P;v[j]=V[j]+sum(k-&gt;E[k[1]]*k[2],d((x[j]+X[j])/2))*dt;end;end;x.=mod.(x,1);
  D[t,1:2].=(sum(E.^2)/N,sum(v.^2)*W/P)./2;D[t,3:4].=sum.((D[t,1:2],v/P));
  scatter(x,v,ylims=(-3,3));D[t,1:3].*=2/W;plot!((1:t)./T,D[1:t,:],legend=0==1)
end every 8"><pre><span class="pl-k">using</span> FFTW,LinearAlgebra,Plots,SpecialFunctions;N<span class="pl-k">=</span><span class="pl-c1">128</span>;P<span class="pl-k">=</span><span class="pl-c1">32</span>N;dt<span class="pl-k">=</span><span class="pl-c1">1</span><span class="pl-k">/</span><span class="pl-c1">6</span>N;T<span class="pl-k">=</span><span class="pl-c1">1024</span>;
W<span class="pl-k">=</span><span class="pl-c1">400</span>;w<span class="pl-k">=</span>W<span class="pl-k">/</span>P<span class="pl-k">*</span>N;ξ<span class="pl-k">=</span>im<span class="pl-k">*</span><span class="pl-c1">zeros</span>(N);x<span class="pl-k">=</span><span class="pl-c1">rand</span>(P);v<span class="pl-k">=</span><span class="pl-c1">rand</span>([<span class="pl-k">-</span><span class="pl-c1">1.0</span>,<span class="pl-c1">1.0</span>],P);r<span class="pl-k">=</span><span class="pl-c1">zeros</span>(N);
E<span class="pl-k">=</span><span class="pl-c1">zeros</span>(N);X<span class="pl-k">=</span><span class="pl-c1">copy</span>(x);V<span class="pl-k">=</span><span class="pl-c1">copy</span>(v);ik<span class="pl-k">=</span><span class="pl-c1">2</span>π<span class="pl-k">*</span>im<span class="pl-k">*</span><span class="pl-c1">vcat</span>(<span class="pl-c1">1</span>,<span class="pl-c1">1</span><span class="pl-k">:</span>N<span class="pl-k">/</span><span class="pl-c1">2</span>,<span class="pl-k">-</span>N<span class="pl-k">/</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-k">-</span><span class="pl-c1">1</span>);D<span class="pl-k">=</span><span class="pl-c1">zeros</span>(T,<span class="pl-c1">4</span>);
<span class="pl-en">f</span>(g,c)<span class="pl-k">=</span><span class="pl-en">erf</span>((g<span class="pl-k">-</span>c)<span class="pl-k">*</span>N)<span class="pl-k">/</span><span class="pl-c1">2</span>;<span class="pl-en">ff</span>(i,c)<span class="pl-k">=</span><span class="pl-c1">f</span>((i<span class="pl-k">+</span><span class="pl-c1">0.5</span>)<span class="pl-k">/</span>N,c)<span class="pl-k">-</span><span class="pl-c1">f</span>((i<span class="pl-k">-</span><span class="pl-c1">0.5</span>)<span class="pl-k">/</span>N,c);l<span class="pl-k">=</span><span class="pl-c1">1e-8</span>;
<span class="pl-en">d</span>(c)<span class="pl-k">=</span>((<span class="pl-c1">mod1</span>(i,N),<span class="pl-c1">ff</span>(i,c)) <span class="pl-k">for</span> i<span class="pl-k">∈</span>(<span class="pl-k">-</span><span class="pl-c1">6</span><span class="pl-k">:</span><span class="pl-c1">6</span>)<span class="pl-k">.</span><span class="pl-k">+</span><span class="pl-c1">Int</span>(<span class="pl-c1">round</span>(c<span class="pl-k">*</span>N)));F<span class="pl-k">=</span><span class="pl-c1">copy</span>(E);
<span class="pl-en">ρ</span>(x,y)<span class="pl-k">=</span>(r<span class="pl-k">.*=</span><span class="pl-c1">0</span>;<span class="pl-k">for</span> j<span class="pl-k">∈</span><span class="pl-c1">d</span>.((x<span class="pl-k">.+</span>y)<span class="pl-k">.</span><span class="pl-k">/</span><span class="pl-c1">2</span>);<span class="pl-k">for</span> k<span class="pl-k">∈</span>j;r[k[<span class="pl-c1">1</span>]]<span class="pl-k">+=</span>k[<span class="pl-c1">2</span>]<span class="pl-k">*</span>w;<span class="pl-k">end</span>;<span class="pl-k">end</span>;r);
<span class="pl-c1">@gif</span> <span class="pl-k">for</span> t <span class="pl-k">∈</span><span class="pl-c1">1</span><span class="pl-k">:</span>T;X<span class="pl-k">.=</span>x;V<span class="pl-k">.=</span>v;F<span class="pl-k">.*=</span><span class="pl-c1">NaN</span>;<span class="pl-k">for</span> _<span class="pl-k">∈</span><span class="pl-c1">0</span><span class="pl-k">:</span><span class="pl-c1">9</span>;<span class="pl-c1">isapprox</span>(F,E,rtol<span class="pl-k">=</span>l)<span class="pl-k">&amp;&amp;</span><span class="pl-k">break</span>;F<span class="pl-k">.=</span>E;
  x<span class="pl-k">.=</span>X<span class="pl-k">.+</span>(v<span class="pl-k">.+</span>V)<span class="pl-k">/</span><span class="pl-c1">2</span><span class="pl-k">*</span>dt;E<span class="pl-k">.=</span><span class="pl-c1">real</span>.(<span class="pl-c1">ifft</span>((ξ<span class="pl-k">.=</span><span class="pl-c1">fft</span>(<span class="pl-c1">ρ</span>(x,X))<span class="pl-k">./</span>ik;ξ[<span class="pl-c1">1</span>]<span class="pl-k">*=</span><span class="pl-c1">0</span>;ξ)));
  <span class="pl-k">for</span> j<span class="pl-k">∈</span><span class="pl-c1">1</span><span class="pl-k">:</span>P;v[j]<span class="pl-k">=</span>V[j]<span class="pl-k">+</span><span class="pl-c1">sum</span>(k<span class="pl-k">-&gt;</span>E[k[<span class="pl-c1">1</span>]]<span class="pl-k">*</span>k[<span class="pl-c1">2</span>],<span class="pl-c1">d</span>((x[j]<span class="pl-k">+</span>X[j])<span class="pl-k">/</span><span class="pl-c1">2</span>))<span class="pl-k">*</span>dt;<span class="pl-k">end</span>;<span class="pl-k">end</span>;x<span class="pl-k">.=</span><span class="pl-c1">mod</span>.(x,<span class="pl-c1">1</span>);
  D[t,<span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-c1">2</span>]<span class="pl-k">.</span><span class="pl-k">=</span>(<span class="pl-c1">sum</span>(E<span class="pl-k">.^</span><span class="pl-c1">2</span>)<span class="pl-k">/</span>N,<span class="pl-c1">sum</span>(v<span class="pl-k">.^</span><span class="pl-c1">2</span>)<span class="pl-k">*</span>W<span class="pl-k">/</span>P)<span class="pl-k">.</span><span class="pl-k">/</span><span class="pl-c1">2</span>;D[t,<span class="pl-c1">3</span><span class="pl-k">:</span><span class="pl-c1">4</span>]<span class="pl-k">.</span><span class="pl-k">=</span><span class="pl-c1">sum</span>.((D[t,<span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-c1">2</span>],v<span class="pl-k">/</span>P));
  <span class="pl-c1">scatter</span>(x,v,ylims<span class="pl-k">=</span>(<span class="pl-k">-</span><span class="pl-c1">3</span>,<span class="pl-c1">3</span>));D[t,<span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-c1">3</span>]<span class="pl-k">.</span><span class="pl-k">*=</span><span class="pl-c1">2</span><span class="pl-k">/</span>W;<span class="pl-c1">plot!</span>((<span class="pl-c1">1</span><span class="pl-k">:</span>t)<span class="pl-k">.</span><span class="pl-k">/</span>T,D[<span class="pl-c1">1</span><span class="pl-k">:</span>t,:],legend<span class="pl-k">=</span><span class="pl-c1">0</span><span class="pl-k">==</span><span class="pl-c1">1</span>)
<span class="pl-k">end</span> every <span class="pl-c1">8</span></pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/jwscook/ParticleInCellCodeGolf.jl/blob/main/gifs/GaussianFixedPoint.gif"><img src="https://github.com/jwscook/ParticleInCellCodeGolf.jl/raw/main/gifs/GaussianFixedPoint.gif" alt="" data-animated-image="" style="max-width: 100%;"></a></p>
<p dir="auto">Note that the trajectories of the particles are smoother, this is because the particle
shape functions are smoother. It's almost possible to see the step changes in velocity
in the gif from the NGP version of the code.</p>
<h2 dir="auto"><a id="user-content-quiet-start" class="anchor" aria-hidden="true" href="#quiet-start"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Quiet start</h2>
<p dir="auto">The bit reversal algorithm can be used as a low discrepancy number generator to
initialise a "quiet start". This reduces noise to a level whereby the electric field
energy grows over the course of ~30 decades! As standard, twice the predicted growth rate is overplotted on the change in integrated electric field energy trace with outstanding agreement.</p>
<div class="highlight highlight-source-julia notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="using FFTW,LinearAlgebra,Plots,SpecialFunctions;pic=()-&gt;(N=64;P=32N;dt=1/6N;
T=2^13;W=32π^2/3;w=W/P*N;ξ=im*zeros(N);x=(bitreverse.(0:P-1).+2.0^63)/2.0^64;
v=collect(1:P.&gt;P/2).*2 .-1.;r=zeros(N);
E=zeros(N);X=copy(x);V=copy(v);ik=2π*im*vcat(1,1:N/2,-N/2+1:-1);D=zeros(T,4);
f(g,c)=erf((g-c)*N)/2;ff(i,c)=f((i+0.5)/N,c)-f((i-0.5)/N,c);l=4eps();
d(c)=((mod1(i,N),ff(i,c)) for i∈(-7:7).+Int(round(c*N)));F=copy(E);
ρ(x,y=x)=(r.*=0;for l∈d.((x.+y)./2);for k∈l;r[k[1]]+=k[2]*w;end;end;r);
@time @gif for t ∈1:T;X.=x;V.=v;F.*=NaN;for _∈0:9;≈(F,E,rtol=l,atol=0)&amp;&amp;break;F.=E;
 x.=X.+(v.+V)/2*dt;E.=real.(ifft((ξ.=fft(ρ(x,X))./ik;ξ[1]*=0;ξ)));
 for j∈1:P;v[j]=V[j]+sum(k-&gt;E[k[1]]*k[2],d((x[j]+X[j])/2))*dt;end;end;x.=mod.(x,1);
 D[t,1:2].=(sum(E.^2)/N,sum(v.^2)*W/P)./2;D[t,3:4].=sum.((D[t,1:2],v/P));
 scatter(x[1:P÷2],v[1:P÷2],c=1);scatter!(x[P÷2+1:P],v[P÷2+1:P],ylims=(-3,3),c=2);
 D[t,1:3].*=2/W;plot!((1:t)./T,D[1:t,:],legend=0==1,xlims=(0,1)); @show t/T
 plot!((0.5:N)/N,ρ(x[1:P÷2])./W,c=1);plot!((0.5:N)/N,ρ(x[P÷2+1:P])./W,c=2)
end every 8;return (D,N,P,dt,T,W,w););(D,N,P,dt,T,W,w)=pic()
la(x)=log10(abs(x));t=(1:T).*dt;plot(t,la.(D[:,1]),label=&quot;electric field energy&quot;)
plot!(t,la.(1 .-D[:,3]),label=&quot;total energy change&quot;);yticks!(-35:1)
plot!(t,la.(D[:,4]),label=&quot;total momentum&quot;,legend=:bottomright)
γ(x)=imag(sqrt(Complex(x^2+1-sqrt(4*x^2+1))))*sqrt(W/2)/log(10);ylims!(-35,1)
plot!(t,2*γ(2π/sqrt(W/2)).*(t.-T÷8*dt).+la.(D[T÷8,1]),label=&quot;predicted&quot;)
xlabel!(&quot;Time&quot;);ylabel!(&quot;log 10&quot;);savefig(&quot;GaussianFixedPointQuiet.jpg&quot;)"><pre><span class="pl-k">using</span> FFTW,LinearAlgebra,Plots,SpecialFunctions;pic<span class="pl-k">=</span>()<span class="pl-k">-&gt;</span>(N<span class="pl-k">=</span><span class="pl-c1">64</span>;P<span class="pl-k">=</span><span class="pl-c1">32</span>N;dt<span class="pl-k">=</span><span class="pl-c1">1</span><span class="pl-k">/</span><span class="pl-c1">6</span>N;
T<span class="pl-k">=</span><span class="pl-c1">2</span><span class="pl-k">^</span><span class="pl-c1">13</span>;W<span class="pl-k">=</span><span class="pl-c1">32</span>π<span class="pl-k">^</span><span class="pl-c1">2</span><span class="pl-k">/</span><span class="pl-c1">3</span>;w<span class="pl-k">=</span>W<span class="pl-k">/</span>P<span class="pl-k">*</span>N;ξ<span class="pl-k">=</span>im<span class="pl-k">*</span><span class="pl-c1">zeros</span>(N);x<span class="pl-k">=</span>(<span class="pl-c1">bitreverse</span>.(<span class="pl-c1">0</span><span class="pl-k">:</span>P<span class="pl-k">-</span><span class="pl-c1">1</span>)<span class="pl-k">.+</span><span class="pl-c1">2.0</span><span class="pl-k">^</span><span class="pl-c1">63</span>)<span class="pl-k">/</span><span class="pl-c1">2.0</span><span class="pl-k">^</span><span class="pl-c1">64</span>;
v<span class="pl-k">=</span><span class="pl-c1">collect</span>(<span class="pl-c1">1</span><span class="pl-k">:</span>P<span class="pl-k">.&gt;</span>P<span class="pl-k">/</span><span class="pl-c1">2</span>)<span class="pl-k">.*</span><span class="pl-c1">2</span> <span class="pl-k">.-</span><span class="pl-c1">1.</span>;r<span class="pl-k">=</span><span class="pl-c1">zeros</span>(N);
E<span class="pl-k">=</span><span class="pl-c1">zeros</span>(N);X<span class="pl-k">=</span><span class="pl-c1">copy</span>(x);V<span class="pl-k">=</span><span class="pl-c1">copy</span>(v);ik<span class="pl-k">=</span><span class="pl-c1">2</span>π<span class="pl-k">*</span>im<span class="pl-k">*</span><span class="pl-c1">vcat</span>(<span class="pl-c1">1</span>,<span class="pl-c1">1</span><span class="pl-k">:</span>N<span class="pl-k">/</span><span class="pl-c1">2</span>,<span class="pl-k">-</span>N<span class="pl-k">/</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-k">-</span><span class="pl-c1">1</span>);D<span class="pl-k">=</span><span class="pl-c1">zeros</span>(T,<span class="pl-c1">4</span>);
<span class="pl-en">f</span>(g,c)<span class="pl-k">=</span><span class="pl-en">erf</span>((g<span class="pl-k">-</span>c)<span class="pl-k">*</span>N)<span class="pl-k">/</span><span class="pl-c1">2</span>;<span class="pl-en">ff</span>(i,c)<span class="pl-k">=</span><span class="pl-c1">f</span>((i<span class="pl-k">+</span><span class="pl-c1">0.5</span>)<span class="pl-k">/</span>N,c)<span class="pl-k">-</span><span class="pl-c1">f</span>((i<span class="pl-k">-</span><span class="pl-c1">0.5</span>)<span class="pl-k">/</span>N,c);l<span class="pl-k">=</span><span class="pl-c1">4</span><span class="pl-c1">eps</span>();
<span class="pl-en">d</span>(c)<span class="pl-k">=</span>((<span class="pl-c1">mod1</span>(i,N),<span class="pl-c1">ff</span>(i,c)) <span class="pl-k">for</span> i<span class="pl-k">∈</span>(<span class="pl-k">-</span><span class="pl-c1">7</span><span class="pl-k">:</span><span class="pl-c1">7</span>)<span class="pl-k">.</span><span class="pl-k">+</span><span class="pl-c1">Int</span>(<span class="pl-c1">round</span>(c<span class="pl-k">*</span>N)));F<span class="pl-k">=</span><span class="pl-c1">copy</span>(E);
<span class="pl-en">ρ</span>(x,y<span class="pl-k">=</span>x)<span class="pl-k">=</span>(r<span class="pl-k">.*=</span><span class="pl-c1">0</span>;<span class="pl-k">for</span> l<span class="pl-k">∈</span><span class="pl-c1">d</span>.((x<span class="pl-k">.+</span>y)<span class="pl-k">.</span><span class="pl-k">/</span><span class="pl-c1">2</span>);<span class="pl-k">for</span> k<span class="pl-k">∈</span>l;r[k[<span class="pl-c1">1</span>]]<span class="pl-k">+=</span>k[<span class="pl-c1">2</span>]<span class="pl-k">*</span>w;<span class="pl-k">end</span>;<span class="pl-k">end</span>;r);
<span class="pl-c1">@time</span> <span class="pl-c1">@gif</span> <span class="pl-k">for</span> t <span class="pl-k">∈</span><span class="pl-c1">1</span><span class="pl-k">:</span>T;X<span class="pl-k">.=</span>x;V<span class="pl-k">.=</span>v;F<span class="pl-k">.*=</span><span class="pl-c1">NaN</span>;<span class="pl-k">for</span> _<span class="pl-k">∈</span><span class="pl-c1">0</span><span class="pl-k">:</span><span class="pl-c1">9</span>;<span class="pl-k">≈</span>(F,E,rtol<span class="pl-k">=</span>l,atol<span class="pl-k">=</span><span class="pl-c1">0</span>)<span class="pl-k">&amp;&amp;</span><span class="pl-k">break</span>;F<span class="pl-k">.=</span>E;
 x<span class="pl-k">.=</span>X<span class="pl-k">.+</span>(v<span class="pl-k">.+</span>V)<span class="pl-k">/</span><span class="pl-c1">2</span><span class="pl-k">*</span>dt;E<span class="pl-k">.=</span><span class="pl-c1">real</span>.(<span class="pl-c1">ifft</span>((ξ<span class="pl-k">.=</span><span class="pl-c1">fft</span>(<span class="pl-c1">ρ</span>(x,X))<span class="pl-k">./</span>ik;ξ[<span class="pl-c1">1</span>]<span class="pl-k">*=</span><span class="pl-c1">0</span>;ξ)));
 <span class="pl-k">for</span> j<span class="pl-k">∈</span><span class="pl-c1">1</span><span class="pl-k">:</span>P;v[j]<span class="pl-k">=</span>V[j]<span class="pl-k">+</span><span class="pl-c1">sum</span>(k<span class="pl-k">-&gt;</span>E[k[<span class="pl-c1">1</span>]]<span class="pl-k">*</span>k[<span class="pl-c1">2</span>],<span class="pl-c1">d</span>((x[j]<span class="pl-k">+</span>X[j])<span class="pl-k">/</span><span class="pl-c1">2</span>))<span class="pl-k">*</span>dt;<span class="pl-k">end</span>;<span class="pl-k">end</span>;x<span class="pl-k">.=</span><span class="pl-c1">mod</span>.(x,<span class="pl-c1">1</span>);
 D[t,<span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-c1">2</span>]<span class="pl-k">.</span><span class="pl-k">=</span>(<span class="pl-c1">sum</span>(E<span class="pl-k">.^</span><span class="pl-c1">2</span>)<span class="pl-k">/</span>N,<span class="pl-c1">sum</span>(v<span class="pl-k">.^</span><span class="pl-c1">2</span>)<span class="pl-k">*</span>W<span class="pl-k">/</span>P)<span class="pl-k">.</span><span class="pl-k">/</span><span class="pl-c1">2</span>;D[t,<span class="pl-c1">3</span><span class="pl-k">:</span><span class="pl-c1">4</span>]<span class="pl-k">.</span><span class="pl-k">=</span><span class="pl-c1">sum</span>.((D[t,<span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-c1">2</span>],v<span class="pl-k">/</span>P));
 <span class="pl-c1">scatter</span>(x[<span class="pl-c1">1</span><span class="pl-k">:</span>P<span class="pl-k">÷</span><span class="pl-c1">2</span>],v[<span class="pl-c1">1</span><span class="pl-k">:</span>P<span class="pl-k">÷</span><span class="pl-c1">2</span>],c<span class="pl-k">=</span><span class="pl-c1">1</span>);<span class="pl-c1">scatter!</span>(x[P<span class="pl-k">÷</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-k">:</span>P],v[P<span class="pl-k">÷</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-k">:</span>P],ylims<span class="pl-k">=</span>(<span class="pl-k">-</span><span class="pl-c1">3</span>,<span class="pl-c1">3</span>),c<span class="pl-k">=</span><span class="pl-c1">2</span>);
 D[t,<span class="pl-c1">1</span><span class="pl-k">:</span><span class="pl-c1">3</span>]<span class="pl-k">.</span><span class="pl-k">*=</span><span class="pl-c1">2</span><span class="pl-k">/</span>W;<span class="pl-c1">plot!</span>((<span class="pl-c1">1</span><span class="pl-k">:</span>t)<span class="pl-k">.</span><span class="pl-k">/</span>T,D[<span class="pl-c1">1</span><span class="pl-k">:</span>t,:],legend<span class="pl-k">=</span><span class="pl-c1">0</span><span class="pl-k">==</span><span class="pl-c1">1</span>,xlims<span class="pl-k">=</span>(<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)); <span class="pl-c1">@show</span> t<span class="pl-k">/</span>T
 <span class="pl-c1">plot!</span>((<span class="pl-c1">0.5</span><span class="pl-k">:</span>N)<span class="pl-k">/</span>N,<span class="pl-c1">ρ</span>(x[<span class="pl-c1">1</span><span class="pl-k">:</span>P<span class="pl-k">÷</span><span class="pl-c1">2</span>])<span class="pl-k">./</span>W,c<span class="pl-k">=</span><span class="pl-c1">1</span>);<span class="pl-c1">plot!</span>((<span class="pl-c1">0.5</span><span class="pl-k">:</span>N)<span class="pl-k">/</span>N,<span class="pl-c1">ρ</span>(x[P<span class="pl-k">÷</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-k">:</span>P])<span class="pl-k">./</span>W,c<span class="pl-k">=</span><span class="pl-c1">2</span>)
<span class="pl-k">end</span> every <span class="pl-c1">8</span>;<span class="pl-k">return</span> (D,N,P,dt,T,W,w););(D,N,P,dt,T,W,w)<span class="pl-k">=</span><span class="pl-c1">pic</span>()
<span class="pl-en">la</span>(x)<span class="pl-k">=</span><span class="pl-c1">log10</span>(<span class="pl-c1">abs</span>(x));t<span class="pl-k">=</span>(<span class="pl-c1">1</span><span class="pl-k">:</span>T)<span class="pl-k">.</span><span class="pl-k">*</span>dt;<span class="pl-c1">plot</span>(t,<span class="pl-c1">la</span>.(D[:,<span class="pl-c1">1</span>]),label<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>electric field energy<span class="pl-pds">"</span></span>)
<span class="pl-c1">plot!</span>(t,<span class="pl-c1">la</span>.(<span class="pl-c1">1</span> <span class="pl-k">.-</span>D[:,<span class="pl-c1">3</span>]),label<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>total energy change<span class="pl-pds">"</span></span>);<span class="pl-c1">yticks!</span>(<span class="pl-k">-</span><span class="pl-c1">35</span><span class="pl-k">:</span><span class="pl-c1">1</span>)
<span class="pl-c1">plot!</span>(t,<span class="pl-c1">la</span>.(D[:,<span class="pl-c1">4</span>]),label<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>total momentum<span class="pl-pds">"</span></span>,legend<span class="pl-k">=</span><span class="pl-c1">:bottomright</span>)
<span class="pl-en">γ</span>(x)<span class="pl-k">=</span><span class="pl-c1">imag</span>(<span class="pl-c1">sqrt</span>(<span class="pl-c1">Complex</span>(x<span class="pl-k">^</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-k">-</span><span class="pl-c1">sqrt</span>(<span class="pl-c1">4</span><span class="pl-k">*</span>x<span class="pl-k">^</span><span class="pl-c1">2</span><span class="pl-k">+</span><span class="pl-c1">1</span>))))<span class="pl-k">*</span><span class="pl-c1">sqrt</span>(W<span class="pl-k">/</span><span class="pl-c1">2</span>)<span class="pl-k">/</span><span class="pl-c1">log</span>(<span class="pl-c1">10</span>);<span class="pl-c1">ylims!</span>(<span class="pl-k">-</span><span class="pl-c1">35</span>,<span class="pl-c1">1</span>)
<span class="pl-c1">plot!</span>(t,<span class="pl-c1">2</span><span class="pl-k">*</span><span class="pl-c1">γ</span>(<span class="pl-c1">2</span>π<span class="pl-k">/</span><span class="pl-c1">sqrt</span>(W<span class="pl-k">/</span><span class="pl-c1">2</span>))<span class="pl-k">.*</span>(t<span class="pl-k">.-</span>T<span class="pl-k">÷</span><span class="pl-c1">8</span><span class="pl-k">*</span>dt)<span class="pl-k">.</span><span class="pl-k">+</span><span class="pl-c1">la</span>.(D[T<span class="pl-k">÷</span><span class="pl-c1">8</span>,<span class="pl-c1">1</span>]),label<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>predicted<span class="pl-pds">"</span></span>)
<span class="pl-c1">xlabel!</span>(<span class="pl-s"><span class="pl-pds">"</span>Time<span class="pl-pds">"</span></span>);<span class="pl-c1">ylabel!</span>(<span class="pl-s"><span class="pl-pds">"</span>log 10<span class="pl-pds">"</span></span>);<span class="pl-c1">savefig</span>(<span class="pl-s"><span class="pl-pds">"</span>GaussianFixedPointQuiet.jpg<span class="pl-pds">"</span></span>)</pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/jwscook/ParticleInCellCodeGolf.jl/blob/main/figs/GaussianFixedPointQuiet.jpg"><img src="https://github.com/jwscook/ParticleInCellCodeGolf.jl/raw/main/figs/GaussianFixedPointQuiet.jpg" width="600" height="400" style="max-width: 100%;"></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/jwscook/ParticleInCellCodeGolf.jl/blob/main/gifs/GaussianFixedPointQuiet.gif"><img src="https://github.com/jwscook/ParticleInCellCodeGolf.jl/raw/main/gifs/GaussianFixedPointQuiet.gif" alt="" data-animated-image="" style="max-width: 100%;"></a></p>
</article></div>